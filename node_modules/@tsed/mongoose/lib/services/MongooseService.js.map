{"version":3,"file":"MongooseService.js","sourceRoot":"","sources":["../../src/services/MongooseService.ts"],"names":[],"mappings":";;;;AAAA,iCAAyC;AACzC,yCAAoC;AACpC,gEAAgC;AAIhC,IAAa,eAAe,GAA5B,MAAa,eAAe;IAA5B;QACW,gBAAW,GAAqC,IAAI,GAAG,EAAE,CAAC;QAC3D,sBAAiB,GAAW,SAAS,CAAC;IA0DhD,CAAC;IArDC;;;OAGG;IACH,KAAK,CAAC,OAAO,CAAC,EAAU,EAAE,GAAW,EAAE,iBAAiC,EAAE,SAAS,GAAG,KAAK;QACzF,IAAI,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE;YAChB,OAAO,MAAM,IAAI,CAAC,GAAG,CAAC,EAAE,CAAE,CAAC;SAC5B;QAED,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,8BAA8B,EAAE,EAAE,CAAC,CAAC;QACrD,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,QAAQ,GAAG,EAAE,CAAC,CAAC;QACjC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,YAAY,IAAI,CAAC,SAAS,CAAC,iBAAiB,CAAC,EAAE,CAAC,CAAC;QAEnE,IAAI;YACF,MAAM,UAAU,GAAG,MAAM,kBAAQ,CAAC,gBAAgB,CAAC,GAAG,EAAE,iBAAiB,CAAC,CAAC;YAC3E,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,EAAE,EAAE,UAAU,CAAC,CAAC;YAErC,IAAI,EAAE,KAAK,SAAS,IAAI,SAAS,EAAE;gBACjC,IAAI,CAAC,iBAAiB,GAAG,EAAE,CAAC;aAC7B;YAED,OAAO,UAAU,CAAC;SACnB;QAAC,OAAO,EAAE,EAAE;YACX,0BAA0B;YAC1B,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;YACtB,0BAA0B;YAC1B,OAAO,CAAC,IAAI,EAAE,CAAC;SAChB;IACH,CAAC;IAED;;;OAGG;IACH,GAAG,CAAC,EAAW;QACb,OAAO,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,EAAE,IAAI,IAAI,CAAC,iBAAiB,CAAC,CAAC;IAC5D,CAAC;IAED;;;;OAIG;IACH,GAAG,CAAC,EAAW;QACb,OAAO,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,EAAE,IAAI,IAAI,CAAC,iBAAiB,CAAC,CAAC;IAC5D,CAAC;IAED,KAAK,CAAC,gBAAgB;QACpB,KAAK,MAAM,CAAC,EAAE,EAAE,UAAU,CAAC,IAAI,IAAI,CAAC,WAAW,CAAC,OAAO,EAAE,EAAE;YACzD,MAAM,UAAU,CAAC,KAAK,EAAE,CAAC;YACzB,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;SAC7B;IACH,CAAC;CACF,CAAA;AAvDC;IADC,WAAM,EAAE;sCACD,eAAM;+CAAC;AALJ,eAAe;IAD3B,YAAO,EAAE;GACG,eAAe,CA4D3B;AA5DY,0CAAe","sourcesContent":["import {Inject, Service} from \"@tsed/di\";\nimport {Logger} from \"@tsed/logger\";\nimport Mongoose from \"mongoose\";\nimport {ConnectOptions} from \"mongoose\";\n\n@Service()\nexport class MongooseService {\n  readonly connections: Map<string, Mongoose.Connection> = new Map();\n  private defaultConnection: string = \"default\";\n\n  @Inject()\n  logger: Logger;\n\n  /**\n   *\n   * @returns {Promise<\"mongoose\".Connection>}\n   */\n  async connect(id: string, url: string, connectionOptions: ConnectOptions, isDefault = false): Promise<any> {\n    if (this.has(id)) {\n      return await this.get(id)!;\n    }\n\n    this.logger.info(`Connect to mongo database: ${id}`);\n    this.logger.debug(`Url: ${url}`);\n    this.logger.debug(`options: ${JSON.stringify(connectionOptions)}`);\n\n    try {\n      const connection = await Mongoose.createConnection(url, connectionOptions);\n      this.connections.set(id, connection);\n\n      if (id === \"default\" || isDefault) {\n        this.defaultConnection = id;\n      }\n\n      return connection;\n    } catch (er) {\n      /* istanbul ignore next */\n      this.logger.error(er);\n      /* istanbul ignore next */\n      process.exit();\n    }\n  }\n\n  /**\n   *\n   * @returns {\"mongoose\".Connection}\n   */\n  get(id?: string): Mongoose.Connection | undefined {\n    return this.connections.get(id || this.defaultConnection);\n  }\n\n  /**\n   *\n   * @param {string} id\n   * @returns {boolean}\n   */\n  has(id?: string): boolean {\n    return this.connections.has(id || this.defaultConnection);\n  }\n\n  async closeConnections() {\n    for (const [id, connection] of this.connections.entries()) {\n      await connection.close();\n      this.connections.delete(id);\n    }\n  }\n}\n"]}