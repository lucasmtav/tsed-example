"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PlatformExpress = void 0;
const common_1 = require("@tsed/common");
const core_1 = require("@tsed/core");
const rawBodyMiddleware_1 = require("../middlewares/rawBodyMiddleware");
const services_1 = require("../services");
/**
 * @platform
 * @express
 */
class PlatformExpress extends common_1.PlatformBuilder {
    static async bootstrap(module, settings = {}) {
        return this.build(PlatformExpress).bootstrap(module, settings);
    }
    useRouter() {
        this.logger.info("Mount app router");
        this.app.getApp().use(rawBodyMiddleware_1.rawBodyMiddleware);
        this.app.getApp().use(this.app.getRouter());
        return this;
    }
    useContext() {
        this.logger.info("Mount app context");
        this.app.getApp().use(async (req, res, next) => {
            await common_1.createContext(this.injector, req, res);
            return next();
        });
        return this;
    }
    async loadRoutes(routes) {
        // disable x-powered-by header
        this.injector.settings.get("env") === core_1.Env.PROD && this.app.getApp().disable("x-powered-by");
        this.configureViewsEngine();
        await super.loadRoutes(routes);
        // NOT FOUND
        this.app.use((req, res) => {
            var _a;
            (_a = this.injector.get(common_1.PlatformExceptions)) === null || _a === void 0 ? void 0 : _a.resourceNotFound(req.$ctx);
        });
        // EXCEPTION FILTERS
        this.app.use((err, req, res, next) => {
            var _a;
            (_a = this.injector.get(common_1.PlatformExceptions)) === null || _a === void 0 ? void 0 : _a.catch(err, req.$ctx);
        });
    }
    configureViewsEngine() {
        const platformViews = this.injector.get(common_1.PlatformViews);
        platformViews.getEngines().forEach(({ extension, engine }) => {
            this.app.getApp().engine(extension, engine);
        });
        platformViews.viewEngine && this.app.getApp().set("view engine", platformViews.viewEngine);
        platformViews.root && this.app.getApp().set("views", platformViews.root);
    }
}
exports.PlatformExpress = PlatformExpress;
PlatformExpress.providers = [
    {
        provide: common_1.PlatformApplication,
        useClass: services_1.PlatformExpressApplication
    },
    {
        provide: common_1.PlatformRouter,
        useClass: services_1.PlatformExpressRouter
    },
    {
        provide: common_1.PlatformHandler,
        useClass: services_1.PlatformExpressHandler
    },
    {
        provide: common_1.PlatformResponse,
        useClass: services_1.PlatformExpressResponse
    },
    {
        provide: common_1.PlatformRequest,
        useClass: services_1.PlatformExpressRequest
    }
];
//# sourceMappingURL=PlatformExpress.js.map