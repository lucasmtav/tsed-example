"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Groups = void 0;
const tslib_1 = require("tslib");
const core_1 = require("@tsed/core");
const micromatch_1 = tslib_1.__importDefault(require("micromatch"));
const jsonEntityFn_1 = require("./jsonEntityFn");
function matchGroups(groups, compareWith = []) {
    const groupsExcludes = groups.filter((group) => group.startsWith("!")).map((group) => group.replace("!", ""));
    const groupsIncludes = groups.filter((group) => !group.startsWith("!"));
    if (groupsExcludes.length) {
        if (compareWith.length && micromatch_1.default(groupsExcludes, compareWith).length) {
            return true;
        }
    }
    if (groupsIncludes.length) {
        return !micromatch_1.default(groups.filter((group) => !group.startsWith("!")), compareWith).length;
    }
    return false;
}
function Groups(...groups) {
    return jsonEntityFn_1.JsonEntityFn((entity) => {
        if (entity.decoratorType === core_1.DecoratorTypes.PROP) {
            entity.schema.$hooks.on("groups", (prev, givenGroups) => {
                if (!prev) {
                    if (matchGroups(groups, givenGroups)) {
                        return true;
                    }
                }
                return prev;
            });
        }
        if (entity.decoratorType === core_1.DecoratorTypes.PARAM) {
            entity.parameter.groups = groups;
        }
    });
}
exports.Groups = Groups;
//# sourceMappingURL=groups.js.map